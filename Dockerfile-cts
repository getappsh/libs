# ==================================
# Build Stage
# Use a Node.js LTS version (Slim or standard)
# ==================================
FROM node:22-slim AS build

# Set working directory
WORKDIR /node-app

# Copy package files first to leverage Docker cache
COPY package*.json /node-app/

# Install ALL dependencies (including dev) needed for build and tests using npm ci
# Ensure package-lock.json is up-to-date and committed
RUN npm ci

# Copy the rest of the application source code
# This invalidates the cache more often, so it comes after npm ci
COPY . .

# Run tests (Optional but recommended)
# RUN npm run test

# Build the application
# Ensure your build script outputs to /node-app/dist
RUN npm run build

# Remove development dependencies (Optional: Alternative to --only=production later)
# RUN npm prune --production

# ==================================
# Final Stage
# Use a minimal Node.js LTS slim image
# ==================================
FROM node:22-slim AS final

# Set environment to production
ENV NODE_ENV=production

# Arguments for user/group IDs (can be passed during build)
ARG UID=1004370000
ARG GID=${UID}
ARG USERNAME=getapp

# Create app directory
WORKDIR /node-app

# Create non-root user and group, install ca-certificates in one layer
# Use addgroup/adduser which are standard utilities
RUN apt-get update && \
    apt-get install -y --no-cache --no-install-recommends ca-certificates && \
    addgroup --gid ${GID} ${USERNAME} && \
    adduser --disabled-password --gecos "" --ingroup ${USERNAME} --uid ${UID} ${USERNAME} && \
    apt-get purge -y --auto-remove && \
    rm -rf /var/lib/apt/lists/*

# Copy package files needed for production install
COPY --chown=${USERNAME}:${USERNAME} package*.json /node-app/

# Install ONLY production dependencies using npm ci
RUN npm ci --only=production --omit=dev

# Copy built application from the build stage
COPY --chown=${USERNAME}:${USERNAME} --from=build /node-app/dist /dist

# Copy other runtime assets if needed (e.g., static config files)
# COPY --chown=${USERNAME}:${USERNAME}./config./config

# Create and write the API version tag file
ARG API_VERSION_TAG=unknown
ENV API_VERSION_TAG=$API_VERSION_TAG
RUN echo "$API_VERSION_TAG" > api_image_version.txt && \
    chown ${USERNAME}:${USERNAME} api_image_version.txt

# Switch to the non-root user
USER ${USERNAME}

# Expose the application port (adjust if necessary)
EXPOSE 3000

# Start the application using node directly
# Adjust the path to your main entrypoint if different
CMD ["node", "dist/apps/api/main.js"]
