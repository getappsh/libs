# Dockerfile to build the getapp application
# to fit the prod environmet in the cts

############################################################
###               ///    CTS part     ///                ###
############################################################
FROM node:19.5.0-alpine as cts

# Minimize installed packages and remove cache
RUN apk --no-cache add ca-certificates bash curl && \
    rm -rf /var/cache/apk/*

WORKDIR /node-app

# ===   create a uid and a gid to fit CTS project uid and setup CA certificates === #
ARG uid=1004370000
ARG username=getapp

# Combine user creation and CA setup in a single layer
RUN echo "${username}:x:${uid}:${uid}:${username}:/home/${username}:/sbin/nologin" >> /etc/passwd && \
    echo "${username}:x:${uid}:" >> /etc/group && \
    mkdir -p /usr/local/share/ca-certificates/ && \
    chown -R ${uid}:${uid} /node-app

ENV CI=true \
    NODE_ENV=production \
    npm_config_cache=/tmp/npm \
    PATH=$PATH:/node-app/node_modules/.bin

############################################################
###               ///       end      ///                 ###
############################################################

# Build stage with minimal dependencies
FROM node:19.5.0-alpine as build

WORKDIR /node-app

# Copy package files first to leverage cache
COPY package*.json ./

# Install dependencies with specific optimizations
RUN npm ci --no-audit --no-optional && \
    npm cache clean --force

# Copy only necessary source files
COPY tsconfig*.json ./ 
COPY . .

# Run tests, build, and optimize node_modules
RUN npm run test && \
    npm run build && \
    rm -rf node_modules && \
    # Install production dependencies with specific optimizations
    npm ci --no-audit --no-optional --production && \
    npm cache clean --force && \
    # Additional node_modules cleanup
    find node_modules -type f -name "*.d.ts" -delete && \
    find node_modules -type f -name "*.map" -delete && \
    find node_modules -type f -name "README*" -delete && \
    find node_modules -type f -name "CHANGELOG*" -delete && \
    find node_modules -type f -name "LICENSE*" -delete && \
    find node_modules -type d -name "test" -exec rm -rf {} + 2>/dev/null || true && \
    find node_modules -type d -name "tests" -exec rm -rf {} + 2>/dev/null || true && \
    find node_modules -type d -name "docs" -exec rm -rf {} + 2>/dev/null || true && \
    find node_modules -type d -name "examples" -exec rm -rf {} + 2>/dev/null || true && \
    # Remove any empty directories
    find node_modules -empty -type d -delete

# Final stage
FROM cts as deploy

ARG uid=1004370000
ARG username=getapp

# Copy only the minimal required files from build stage
COPY --chown=${uid}:${uid} package*.json ./
COPY --chown=${uid}:${uid} --from=build /node-app/node_modules/ ./node_modules/
COPY --chown=${uid}:${uid} --from=build /node-app/dist/ ./

# Set version info in a single layer
ARG api_version_tag
ENV api_version_tag=$api_version_tag
RUN echo "$api_version_tag" > api_image_version.txt

USER ${username}


CMD ["node", "--optimize_for_size", "--gc_interval=100", "apps/api/main.js"]
