# Dockerfile to build the getapp application
# to fit the prod environmet in the cts

############################################################
###               ///   stage 1     ///                ###
############################################################
FROM node:19.5.0-alpine as cts

WORKDIR /node-app

# ===   create a uid and a gid to fit CTS project uid and setup CA certificates === #
ARG uid=1004370000 \
    username=getapp

# Combine user creation and CA setup in a single layer
RUN echo "${username}:x:${uid}:${uid}:${username}:/home/${username}:/sbin/nologin" >> /etc/passwd && \
    echo "${username}:x:${uid}:" >> /etc/group && \
    apk --no-cache add ca-certificates bash curl && \
    mkdir -p /usr/local/share/ca-certificates/ && \
    chown -R ${uid}:${uid} /node-app

# ===   inside part - must be run inside in the CTS   === #
# Update the CA certificates bundle inside the container
# inside the CTS build the image only with these two lines, ant commit all the rest.
# COPY idfcts/* /usr/local/share/ca-certificates/
# RUN update-ca-certificates

ENV CI=true

############################################################
###               ///       stage 2     ///                 ###
############################################################

# Build stage with minimal dependencies
FROM node:19.5.0-alpine as build

WORKDIR /node-app

# Copy package files first to leverage cache
COPY package*.json ./

# Install dependencies and clean npm cache
RUN npm ci && \
    npm cache clean --force

# Copy source files needed for build
COPY . .

# Run tests and build, then create a clean production node_modules
RUN npm run test && \
    npm run build && \
    rm -rf node_modules && \
    npm ci --only=production && \
    npm cache clean --force && \
    # Remove unnecessary files from node_modules
    find node_modules -type f -name "*.d.ts" -delete && \
    find node_modules -type f -name "*.map" -delete && \
    find node_modules -type d -name "test" -exec rm -rf {} + 2>/dev/null || true && \
    find node_modules -type d -name "tests" -exec rm -rf {} + 2>/dev/null || true && \
    find node_modules -type d -name "docs" -exec rm -rf {} + 2>/dev/null || true

############################################################
###               ///       stage 3     ///                 ###
############################################################
FROM cts as deploy

ENV NODE_ENV=production \
    api_version_tag=$api_version_tag

ARG uid=1004370000 \
    username=getapp \
    api_version_tag

# Copy only the minimal required files from build stage
COPY --chown=${uid}:${uid} package*.json ./
COPY --chown=${uid}:${uid} --from=build /node-app/node_modules ./node_modules
COPY --chown=${uid}:${uid} --from=build /node-app/dist/ .

# Set version info in a single layer
RUN echo "$api_version_tag" > api_image_version.txt

USER ${username}
CMD ["node", "apps/api/main.js"]
