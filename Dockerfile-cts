# Dockerfile to build the getapp application
# Optimized for smaller final image size

############################################################
###   Base Stage - Common setup for Node Alpine        ###
############################################################
FROM node:19.5.0-alpine as base

# Install essential CA certificates - usually needed
RUN apk --no-cache add ca-certificates

# Set up working directory
WORKDIR /node-app

# Create non-root user and group matching CTS requirements
# Using addgroup/adduser is slightly cleaner if available (usually are in Alpine)
ARG UID=1004370000
ARG GID=${UID} # Often UID and GID are the same
ARG USERNAME=getapp
RUN addgroup -g ${GID} ${USERNAME} && \
    adduser -u ${UID} -G ${USERNAME} -D -h /home/${USERNAME} ${USERNAME}
# RUN echo "${USERNAME}:x:${UID}:${GID}:${USERNAME}:/home/${USERNAME}:/sbin/nologin" >> /etc/passwd # Alternative manual way
# RUN echo "${USERNAME}:x:${GID}:" >> /etc/group                                        # Alternative manual way

# Optional: Add custom CA certs if needed at RUNTIME (copied later)
# RUN mkdir -p /usr/local/share/ca-certificates/my-custom-cas
# COPY --chown=${UID}:${GID} idfcts/*.crt /usr/local/share/ca-certificates/my-custom-cas/
# RUN update-ca-certificates

############################################################
###   Builder Stage - Install deps, build the app      ###
############################################################
FROM base as builder
# Root is often needed for global npm installs or certain build steps
USER root

# Install ALL dependencies (including dev)
COPY package*.json ./
RUN npm install --ignore-scripts # Use --ignore-scripts if postinstall isn't needed for build

# Copy application code
# Make sure you have a good .dockerignore file!
COPY --chown=${UID}:${GID} . .

# Run tests (optional in builder, depends on workflow)
# RUN npm run test

# Build the application
RUN npm run build

# Optional Pruning: Install only prod dependencies for cleaner copy later
# This creates a clean node_modules with only production deps
RUN npm prune --production

############################################################
###   Final Stage - Minimal runtime environment        ###
############################################################
FROM base as final

ARG UID=1004370000
ARG GID=${UID}
ARG USERNAME=getapp
ENV NODE_ENV=production

WORKDIR /node-app

# Copy only necessary files from the builder stage
# 1. Copy production node_modules (pruned in builder stage)
COPY --from=builder --chown=${UID}:${GID} /node-app/node_modules ./node_modules
# 2. Copy built application artifacts
COPY --from=builder --chown=${UID}:${GID} /node-app/dist ./dist
# 3. Copy package.json (maybe needed by runtime, e.g., for version info)
#    If not needed at runtime, you can potentially remove this COPY line.
COPY --from=builder --chown=${UID}:${GID} /node-app/package.json ./package.json

# Alternative to copying node_modules from builder: Install prod deps here
# This is simpler if you don't prune in the builder, but adds an npm install step/layer here.
# COPY --chown=${UID}:${GID} package*.json ./
# RUN npm install --only=production --omit=dev --ignore-scripts && \
#     npm cache clean --force && \
#     rm -rf /tmp/* # Clean up npm cache and tmp files

# Add version file
ARG API_VERSION_TAG=unknown
ENV API_VERSION_TAG=${API_VERSION_TAG}
RUN echo "$API_VERSION_TAG" > api_image_version.txt
RUN chown ${UID}:${GID} api_image_version.txt

# Ensure correct ownership of the entire app directory
# RUN chown -R ${UID}:${GID} /node-app # Might not be needed if COPY --chown works reliably

# Switch to the non-root user
USER ${USERNAME}

# Expose port if necessary (replace 3000 with your app's port)
# EXPOSE 3000

# Define the command to run the application
# Adjust the path if your main entrypoint is different after build
CMD ["node", "dist/apps/api/main.js"]
